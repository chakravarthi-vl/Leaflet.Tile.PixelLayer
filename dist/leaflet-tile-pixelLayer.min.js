"use strict";!function(){function v(t){return null!=t}function e(t,i){var e=t[0],a=t[1],r=t[2],o=i[0]-e,n=i[1]-a,l=i[2]-r;return function(t,i){return[Math.floor(e+t*o),Math.floor(a+t*n),Math.floor(r+t*l),i]}}function l(t,i,e){return(function(t,i){return Math.max(i[0],Math.min(t,i[1]))}(t,[i,e])-i)/(e-i)}L.TilePixelLayer=L.TileLayer.extend({options:{data:null,overlayAlpha:230,gap:2,zIndex:7,gradient:[]},map:null,builder:null,grid:null,gridDataBuilt:null,date:null,replaceNaN:!0,replaceNaNValue:0,zooming:!1,"λ0":null,"φ0":null,"Δλ":null,"Δφ":null,ni:null,nj:null,triggerDraw:[],initialize:function(t){L.setOptions(this,t),this.gradient=function(t){for(var r=[],o=[],n=[],i=0;i<t.length-1;i++)r.push(t[i+1][0]),o.push(e(t[i][1],t[i+1][1])),n.push([t[i][0],t[i+1][0]]);return function(t,i){for(var e=0;e<r.length-1&&!(t<=r[e]);e++);var a=n[e];return o[e](l(t,a[0],a[1]),i)}}(t.gradient)},createTile:function(t){var i=L.DomUtil.create("canvas","leaflet-pixel-tile"),e=this.getTileSize();if(i.width=e.x,i.height=e.y,this.zooming)return i;var a=i.getContext("2d"),r={x:t.x*i.width,y:t.y*i.height,z:t.z,w:i.width,h:i.height},o=this;return o.gridDataBuilt?o.interpolateField(a,r,function(t){a.putImageData(t,0,0)}):o.triggerDraw.push(function(){o.interpolateField(a,r,function(t){a.putImageData(t,0,0)})}),i},onAdd:function(t){var o=this,n=this;this.triggerDraw.splice(0,this.triggerDraw.length),this.map=t,this.handleZoom(),this.initHandlers(),this.buildGrid(n.options.data,function(t){n.gridDataBuilt=t;for(var i=0;i<n.triggerDraw.length;i++)n.triggerDraw[i]();n.triggerDraw=[]}),this.map.on("click",function(t){var i=t.latlng,e=i.lat,a=i.lng,r=n.gridDataBuilt.interpolate(a,e);o.options.clickEvt&&o.options.clickEvt(t,r)}),L.TileLayer.prototype.onAdd.call(this,t)},onRemove:function(t){this.gridDataBuilt=null,this.triggerDraw&&this.triggerDraw.splice(0,this.triggerDraw.length),L.TileLayer.prototype.onRemove.call(this,t)},initHandlers:function(){var t=this;this.map.on("zoomstart",function(){t.lastZoomDate=Date.now(),t.options.maxNativeZoom=t._tileZoom,L.setOptions(t,t.options),t.zooming=!0})},handleZoom:function(){var a=this;a.oldMapZoom=a.map.getZoom(),a.oldTileZoom=a._tileZoom,clearInterval(a.map.zoomInterval),a.map.zoomInterval=setInterval(function(){if(500<Date.now()-a.lastZoomDate&&a.zooming){a.zooming=!1,a.options.maxNativeZoom=13,L.setOptions(a,a.options);var t=.2<a.oldMapZoom-a.map.getZoom(),i=a.oldTileZoom!=Math.floor(a.map.getZoom()),e=void 0===a.oldTileZoom;(t||i||e)&&(a.redraw(),a.oldTileZoom=a._tileZoom,a.oldMapZoom=a.map.getZoom(),a.options.maxNativeZoom=a._tileZoom,L.setOptions(a,a.options))}},300)},createBuilder:function(i){return{header:i.header,data:function(t){return i.data[t]},interpolate:this.bilinearInterpolateScalar}},buildGrid:function(t,i){var p=this;this.builder=this.createBuilder(t[0]);var e=this.builder.header;this.λ0=e.lo1,this.φ0=e.la1,this.Δλ=e.dx,this.Δφ=e.dy,this.ni=e.nx,this.nj=e.ny,this.date=new Date(e.refTime),this.date.setHours(this.date.getHours()+e.forecastTime),this.grid=[];for(var a=360<=Math.floor(this.ni*this.Δλ),r=0,o=0;o<this.nj;o++){for(var n=[],l=0;l<this.ni;l++,r++)n[l]=this.builder.data(r),this.replaceNaN&&isNaN(n[l])&&(n[l]=this.replaceNaNValue);a&&(n.push(n[0]),this.grid[o]=n)}i({date:this.date,interpolate:function(t,i){if(!p.grid)return null;var e,a=function(t,i){return t-i*Math.floor(t/i)}(t-p.λ0,360)/p.Δλ,r=(p.φ0-i)/p.Δφ,o=Math.floor(a),n=o+1,l=Math.floor(r),s=l+1;if(e=p.grid[l]){var u=e[o],h=e[n];if(v(u)&&v(h)&&(e=p.grid[s])){var d=e[o],g=e[n];if(v(d)&&v(g))return p.builder.interpolate(a-o,r-l,u,h,d,g)}}return null}})},pointToCoord:function(t,i,e){var a=this.map.unproject(L.point(t,i),e);return[a.lng,a.lat]},createMask:function(t,i){if(!t)return null;var r=i.w,e=i.h;t.fillStyle="rgba(255, 255, 255, 0.1)",t.fill();var a=t.getImageData(0,0,r,e),o=a.data;return{imageData:a,set:function(t,i,e){var a=4*(i*r+t);return o[a]=e[0],o[1+a]=e[1],o[2+a]=e[2],o[3+a]=e[3],this}}},bilinearInterpolateScalar:function(t,i,e,a,r,o){var n=1-t,l=1-i;return e*n*l+a*t*l+r*n*i+o*t*i},interpolateField:function(t,g,e){var p=this,a=g.x,r=0,i=this.options.gap;(!Number.isInteger(this.options.gap)||this.options.gap<1)&&(console.warn("Option Gap Must be interger and greater than 0!"),i=2);var f=i,c=i,m=this.createMask(t,g);function o(t,i){for(var e=[0,0,0,1],a=g.y,r=0;r<=g.h;a+=c,r+=c){var o=e,n=p.pointToCoord(t,a,g.z);if(n){var l=n[0],s=n[1];if(isFinite(l)){var u=p.gridDataBuilt.interpolate(l,s);v(u)&&(o=p.gradient(u,p.options.overlayAlpha))}}for(var h=0;h<f;h++)for(var d=0;d<c;d++)m.set(i+h,r+d,o)}}!function t(){for(var i=Date.now();r<g.w;)if(o(a,r),a+=f,r+=f,500<Date.now()-i)return void setTimeout(t,25);e(m.imageData)}()}}),L.tilePixelLayer=function(t){return new L.TilePixelLayer(t)}}();