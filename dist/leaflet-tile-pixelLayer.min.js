"use strict";!function(){function v(t){return null!=t}function a(t,i){var a=t[0],e=t[1],r=t[2],n=i[0]-a,o=i[1]-e,l=i[2]-r;return function(t,i){return[Math.floor(a+t*n),Math.floor(e+t*o),Math.floor(r+t*l),i]}}function l(t,i,a){return(function(t,i){return Math.max(i[0],Math.min(t,i[1]))}(t,[i,a])-i)/(a-i)}L.TilePixelLayer=L.TileLayer.extend({options:{data:null,overlayAlpha:230,gap:2,zIndex:7,gradient:[]},map:null,builder:null,grid:null,gridDataBuilt:null,date:null,replaceNaN:!0,replaceNaNValue:0,zooming:!1,"λ0":null,"φ0":null,"Δλ":null,"Δφ":null,ni:null,nj:null,triggerDraw:[],initialize:function(t){L.setOptions(this,t),this.gradient=function(t){for(var r=[],n=[],o=[],i=0;i<t.length-1;i++)r.push(t[i+1][0]),n.push(a(t[i][1],t[i+1][1])),o.push([t[i][0],t[i+1][0]]);return function(t,i){for(var a=0;a<r.length-1&&!(t<=r[a]);a++);var e=o[a];return n[a](l(t,e[0],e[1]),i)}}(t.gradient)},createTile:function(t){var i=L.DomUtil.create("canvas","leaflet-pixel-tile"),a=this.getTileSize();if(i.width=a.x,i.height=a.y,this.zooming)return i;var e=i.getContext("2d"),r={x:t.x*i.width,y:t.y*i.height,z:t.z,w:i.width,h:i.height},n=this;return n.gridDataBuilt?n.interpolateField(e,r,function(t){e.putImageData(t,0,0)}):n.triggerDraw.push(function(){n.interpolateField(e,r,function(t){e.putImageData(t,0,0)})}),i},onAdd:function(i){var n=this,o=this;this.triggerDraw.splice(0,this.triggerDraw.length),this.map=i,this.handleZoom(),function(t){var i=t.url,g=t.data;return new Promise(function(s){i||s(g);var h=g.min,d=new Image;d.src=i,d.onload=function(){var t=document.createElement("canvas");t.width=d.width,t.height=d.height;var i=t.getContext("2d");i.drawImage(d,0,0);for(var a=i.getImageData(0,0,d.width,d.height),e=[],r=0;r<a.data.length;r+=4){var n=a.data[r].toString(),o=a.data[r+1].toString(),l=a.data[r+2].toString(),u=Number(n+o+l)-Math.abs(h);e.push(u)}s([{header:g,data:e}])}})}(this.options).then(function(t){n.buildGrid(t,function(t){o.gridDataBuilt=t;for(var i=0;i<o.triggerDraw.length;i++)o.triggerDraw[i]();o.triggerDraw=[]}),n.map.on("click",function(t){var i=t.latlng,a=i.lat,e=i.lng,r=o.gridDataBuilt.interpolate(e,a);n.options.clickEvt&&n.options.clickEvt(t,r)}),L.TileLayer.prototype.onAdd.call(n,i)})},onRemove:function(t){this.gridDataBuilt=null,this.triggerDraw&&this.triggerDraw.splice(0,this.triggerDraw.length),L.TileLayer.prototype.onRemove.call(this,t)},initHandlers:function(){var t=this;this.map.on("zoomstart",function(){t.lastZoomDate=Date.now(),t.options.maxNativeZoom=t._tileZoom,L.setOptions(t,t.options),t.zooming=!0})},handleZoom:function(){var e=this;e.oldMapZoom=e.map.getZoom(),e.oldTileZoom=e._tileZoom,clearInterval(e.map.zoomInterval),e.map.zoomInterval=setInterval(function(){if(500<Date.now()-e.lastZoomDate&&e.zooming){e.zooming=!1,e.options.maxNativeZoom=13,L.setOptions(e,e.options);var t=.2<e.oldMapZoom-e.map.getZoom(),i=e.oldTileZoom!=Math.floor(e.map.getZoom()),a=void 0===e.oldTileZoom;(t||i||a)&&(e.redraw(),e.oldTileZoom=e._tileZoom,e.oldMapZoom=e.map.getZoom(),e.options.maxNativeZoom=e._tileZoom,L.setOptions(e,e.options))}},300)},createBuilder:function(i){return{header:i.header,data:function(t){return i.data[t]},interpolate:this.bilinearInterpolateScalar}},buildGrid:function(t,i){var p=this;this.builder=this.createBuilder(t[0]);var a=this.builder.header;this.λ0=a.lo1,this.φ0=a.la1,this.Δλ=a.dx,this.Δφ=a.dy,this.ni=a.nx,this.nj=a.ny,this.date=new Date(a.refTime),this.date.setHours(this.date.getHours()+a.forecastTime),this.grid=[];for(var e=0,r=0;r<this.nj;r++){for(var n=[],o=0;o<this.ni;o++,e++)n[o]=this.builder.data(e),this.replaceNaN&&isNaN(n[o])&&(n[o]=this.replaceNaNValue);n.push(n[0]),this.grid[r]=n}i({date:this.date,interpolate:function(t,i){if(!p.grid)return null;var a,e=function(t,i){return t-i*Math.floor(t/i)}(t-p.λ0,360)/p.Δλ,r=(p.φ0-i)/p.Δφ,n=Math.floor(e),o=n+1,l=Math.floor(r),u=l+1;if(a=p.grid[l]){var s=a[n],h=a[o];if(v(s)&&v(h)&&(a=p.grid[u])){var d=a[n],g=a[o];if(v(d)&&v(g))return p.builder.interpolate(e-n,r-l,s,h,d,g)}}return null}})},pointToCoord:function(t,i,a){var e=this.map.unproject(L.point(t,i),a);return[e.lng,e.lat]},createMask:function(t,i){if(!t)return null;var r=i.w,a=i.h;t.fillStyle="rgba(255, 255, 255, 0.1)",t.fill();var e=t.getImageData(0,0,r,a),n=e.data;return{imageData:e,set:function(t,i,a){var e=4*(i*r+t);return n[e]=a[0],n[1+e]=a[1],n[2+e]=a[2],n[3+e]=a[3],this}}},bilinearInterpolateScalar:function(t,i,a,e,r,n){var o=1-t,l=1-i;return a*o*l+e*t*l+r*o*i+n*t*i},interpolateField:function(t,g,a){var p=this,e=g.x,r=0,i=this.options.gap;(!Number.isInteger(this.options.gap)||this.options.gap<1)&&(console.warn("Option Gap Must be interger and greater than 0!"),i=2);var c=i,f=i,m=this.createMask(t,g);function n(t,i){for(var a=[0,0,0,1],e=g.y,r=0;r<=g.h;e+=f,r+=f){var n=a,o=p.pointToCoord(t,e,g.z);if(o){var l=o[0],u=o[1];if(isFinite(l)){var s=p.gridDataBuilt.interpolate(l,u);v(s)&&(n=p.gradient(s,p.options.overlayAlpha))}}for(var h=0;h<c;h++)for(var d=0;d<f;d++)m.set(i+h,r+d,n)}}!function t(){for(var i=Date.now();r<g.w;)if(n(e,r),e+=c,r+=c,500<Date.now()-i)return void setTimeout(t,25);a(m.imageData)}()}}),L.tilePixelLayer=function(t){return new L.TilePixelLayer(t)}}();