"use strict";!function(){function v(t){return null!=t}function e(t,i){var e=t[0],o=t[1],r=t[2],a=i[0]-e,n=i[1]-o,l=i[2]-r;return function(t,i){return[Math.floor(e+t*a),Math.floor(o+t*n),Math.floor(r+t*l),i]}}function l(t,i,e){return(function(t,i){return Math.max(i[0],Math.min(t,i[1]))}(t,[i,e])-i)/(e-i)}L.TilePixelLayer=L.TileLayer.extend({options:{data:null,overlayAlpha:230,unit:"",zIndex:7,gradient:function(t){for(var r=[],a=[],n=[],i=0;i<t.length-1;i++)r.push(t[i+1][0]),a.push(e(t[i][1],t[i+1][1])),n.push([t[i][0],t[i+1][0]]);return function(t,i){for(var e=0;e<r.length-1&&!(t<=r[e]);e++);var o=n[e];return a[e](l(t,o[0],o[1]),i)}}([[233.15,[56,4,45]],[243.15,[48,0,106]],[253.15,[0,14,134]],[256.15,[3,44,144]],[218.15,[9,69,162]],[263.15,[37,110,174]],[268.15,[4,147,204]],[275.15,[17,180,240]],[278.15,[92,214,205]],[283.15,[112,190,125]],[288.15,[161,209,115]],[293.15,[255,247,105]],[298.15,[240,200,68]],[303.15,[247,151,19]],[308.15,[214,30,0]],[313.15,[151,14,2]],[318.15,[107,11,0]],[323.15,[73,1,3]]])},map:null,builder:null,grid:null,gridDataBuilt:null,date:null,replaceNaN:!0,replaceNaNValue:0,zooming:!1,"λ0":null,"φ0":null,"Δλ":null,"Δφ":null,ni:null,nj:null,triggerDraw:[],initialize:function(t){L.setOptions(this,t),L.TileLayer.prototype.initialize.call(this,t)},createTile:function(t){var i=L.DomUtil.create("canvas","leaflet-pixel-tile"),e=this.getTileSize();if(i.width=e.x,i.height=e.y,this.zooming)return i;var o=i.getContext("2d"),r={x:t.x*i.width,y:t.y*i.height,z:t.z,w:i.width,h:i.height},a=this;return a.gridDataBuilt?a.interpolateField(o,r,function(t){o.putImageData(t,0,0)}):a.triggerDraw.push(function(){a.interpolateField(o,r,function(t){o.putImageData(t,0,0)})}),i},onAdd:function(t){var e=this;e.triggerDraw.splice(0,this.triggerDraw.length),e.map=t,e.handleZoom(),e.initHandlers(),e.buildGrid(e.options.data,function(t){e.gridDataBuilt=t;for(var i=0;i<e.triggerDraw.length;i++)e.triggerDraw[i]();e.triggerDraw=[]}),e.map.on("click",function(t){console.log("map clicked"),console.log(t)}),L.TileLayer.prototype.onAdd.call(this,t)},onRemove:function(t){this.gridDataBuilt=null,this.triggerDraw&&this.triggerDraw.splice(0,this.triggerDraw.length),L.TileLayer.prototype.onRemove.call(this,t)},initHandlers:function(){var t=this;this.map.on("zoomstart",function(){t.lastZoomDate=Date.now(),t.options.maxNativeZoom=t._tileZoom,L.setOptions(t,t.options),t.zooming=!0})},handleZoom:function(){var o=this;o.oldMapZoom=o.map.getZoom(),o.oldTileZoom=o._tileZoom,clearInterval(o.map.zoomInterval),o.map.zoomInterval=setInterval(function(){if(500<Date.now()-o.lastZoomDate&&o.zooming){o.zooming=!1,o.options.maxNativeZoom=13,L.setOptions(o,o.options);var t=.2<o.oldMapZoom-o.map.getZoom(),i=o.oldTileZoom!=Math.floor(o.map.getZoom()),e=void 0===o.oldTileZoom;(t||i||e)&&(o.redraw(),o.oldTileZoom=o._tileZoom,o.oldMapZoom=o.map.getZoom(),o.options.maxNativeZoom=o._tileZoom,L.setOptions(o,o.options))}},300)},createBuilder:function(i){return{header:i.header,data:function(t){return i.data[t]},interpolate:this.bilinearInterpolateScalar}},buildGrid:function(t,i){var p=this;this.builder=this.createBuilder(t[0]);var e=this.builder.header;this.λ0=e.lo1,this.φ0=e.la1,this.Δλ=e.dx,this.Δφ=e.dy,this.ni=e.nx,this.nj=e.ny,this.date=new Date(e.refTime),this.date.setHours(this.date.getHours()+e.forecastTime),this.grid=[];for(var o=360<=Math.floor(this.ni*this.Δλ),r=0,a=0;a<this.nj;a++){for(var n=[],l=0;l<this.ni;l++,r++)n[l]=this.builder.data(r),this.replaceNaN&&isNaN(n[l])&&(n[l]=this.replaceNaNValue);o&&(n.push(n[0]),this.grid[a]=n)}i({date:this.date,interpolate:function(t,i){if(!p.grid)return null;var e,o=function(t,i){return t-i*Math.floor(t/i)}(t-p.λ0,360)/p.Δλ,r=(p.φ0-i)/p.Δφ,a=Math.floor(o),n=a+1,l=Math.floor(r),u=l+1;if(e=p.grid[l]){var s=e[a],h=e[n];if(v(s)&&v(h)&&(e=p.grid[u])){var d=e[a],f=e[n];if(v(d)&&v(f))return p.builder.interpolate(o-a,r-l,s,h,d,f)}}return null}})},pointToCoord:function(t,i,e){var o=this.map.unproject(L.point(t,i),e);return[o.lng,o.lat]},createMask:function(t,i){if(!t)return null;var r=i.w,e=i.h;t.fillStyle="rgba(255, 255, 255, 0.1)",t.fill();var o=t.getImageData(0,0,r,e),a=o.data;return{imageData:o,set:function(t,i,e){var o=4*(i*r+t);return a[o]=e[0],a[1+o]=e[1],a[2+o]=e[2],a[3+o]=e[3],this}}},bilinearInterpolateScalar:function(t,i,e,o,r,a){var n=1-t,l=1-i;return e*n*l+o*t*l+r*n*i+a*t*i},interpolateField:function(t,f,e){var p=this,o=f.x,r=0,g=2,c=2,m=this.createMask(t,f);function a(t,i){for(var e=[0,0,0,1],o=f.y,r=0;r<=f.h;o+=c,r+=c){var a=e,n=p.pointToCoord(t,o,f.z);if(n){var l=n[0],u=n[1];if(isFinite(l)){var s=p.gridDataBuilt.interpolate(l,u);v(s)&&(a=p.options.gradient(s,p.options.overlayAlpha))}}for(var h=0;h<g;h++)for(var d=0;d<c;d++)m.set(i+h,r+d,a)}}!function t(){for(var i=Date.now();r<f.w;)if(a(o,r),o+=g,r+=g,500<Date.now()-i)return void setTimeout(t,25);e(m.imageData)}()}}),L.tilePixelLayer=function(t){return new L.TilePixelLayer(t)}}();